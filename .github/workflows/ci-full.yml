name: CI - Full (with E2E)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Verify installation
      run: |
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"
        echo "Workspaces found:"
        npm run --workspaces --if-present --silent list
        
    - name: Build shared package
      run: npm run build --workspace=shared
      
    - name: Build server package
      run: npm run build --workspace=server
      
    - name: Build client package
      run: npm run build --workspace=client
      
    - name: TypeScript checks
      run: npm run typecheck
      
    - name: ESLint checks
      run: npm run lint
      
    - name: Jest unit tests
      run: npm run test
      
    - name: Check if server was already built
      run: |
        echo "Checking if server build from earlier step still exists:"
        ls -la packages/server/ || echo "No server directory"
        ls -la packages/server/dist/ || echo "No dist directory from earlier build"
        
    - name: Start server for E2E tests  
      run: |
        echo "=== DEBUGGING SERVER BUILD ==="
        echo "Current working directory: $(pwd)"
        echo "Server package.json exists:" 
        cat packages/server/package.json | grep -A5 -B5 '"build"'
        
        echo "Server tsconfig.json:"
        cat packages/server/tsconfig.json
        
        echo "Server source files:"
        find packages/server/src -name "*.ts" | head -10
        
        echo "=== CHECKING SHARED PACKAGE ==="
        echo "Shared package contents:"
        ls -la packages/shared/ || echo "No shared directory"
        ls -la packages/shared/dist/ || echo "No shared/dist directory"  
        echo "node_modules shared link:"
        ls -la packages/server/node_modules/shared || echo "No shared symlink in node_modules"
        
        echo "=== BUILDING SERVER ==="
        cd packages/server
        echo "In server directory: $(pwd)"
        echo "Running TypeScript compilation with explicit error checking..."
        if npx tsc; then
          echo "‚úÖ TypeScript compilation succeeded"
        else
          echo "‚ùå TypeScript compilation failed with exit code $?"
        fi
        
        echo "=== AFTER BUILD ==="
        echo "Contents of server directory:"
        ls -la
        echo "Contents of dist directory:"
        ls -la dist/ || echo "No dist directory"
        echo "Contents of dist/src directory:"
        ls -la dist/src/ || echo "No dist/src directory"
        echo "Looking for any .js files in dist:"
        find dist -name "*.js" -type f || echo "No .js files found in dist"
        
        cd ../..
        echo "Back to root: $(pwd)"
        
        if [ -f "packages/server/dist/server.js" ]; then
          echo "‚úÖ server.js found, starting server..."
          npm run start --workspace=server &
        else
          echo "‚ùå server.js not found, cannot start server"
          echo "SERVER_BUILD_FAILED=true" >> $GITHUB_ENV
        fi
      
    - name: Wait for server to start
      run: |
        echo "Waiting for server to start on port 3001..."
        timeout 30 bash -c 'until curl -f http://localhost:3001/health 2>/dev/null || nc -z localhost 3001; do sleep 1; done' || echo "Server didn't start within 30 seconds"
        sleep 2  # Additional buffer
      
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          playwright-${{ runner.os }}-
          
    - name: Install Playwright browsers
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: npx playwright install --with-deps
      
    - name: Playwright E2E tests
      id: e2e-tests
      continue-on-error: true  # Don't fail the job if E2E tests fail
      run: npm run test:e2e
      
    - name: Upload test results and videos
      if: always()  # Always upload, even if tests fail
      uses: actions/upload-artifact@v4
      with:
        name: playwright-results-${{ github.run_id }}
        path: |
          test-results/
          playwright-report/
        retention-days: 30
        
    - name: Check E2E test results
      if: steps.e2e-tests.outcome == 'failure'
      run: |
        echo "::warning::E2E tests failed but artifacts were uploaded"
        exit 1  # Still fail the job, but after uploading artifacts
      
  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.test.result == 'success'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build shared package
      run: npm run build --workspace=shared
      
    - name: Build client for production
      run: npm run build --workspace=client
      
    - name: Deploy to Vercel
      working-directory: packages/client
      run: |
        npm install vercel --save-dev
        mkdir -p .vercel
        echo '{"orgId":"${{ secrets.VERCEL_ORG_ID }}","projectId":"${{ secrets.VERCEL_PROJECT_ID }}"}' > .vercel/project.json
        npx vercel --token ${{ secrets.VERCEL_TOKEN }} --prod --yes

  notify:
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    steps:
    - name: Notify Slack on deployment success
      if: needs.test.result == 'success' && needs.deploy.result == 'success'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"üöÄ *Full CI (E2E) + Deployed to Production*\n‚Ä¢ Branch: `${{ github.ref_name }}`\n‚Ä¢ Commit: `${{ github.sha }}`\n‚Ä¢ Author: ${{ github.actor }}\n‚Ä¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: Notify Slack on test success only
      if: needs.test.result == 'success' && needs.deploy.result == 'skipped'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"‚úÖ *Full CI (E2E) Pipeline Success*\n‚Ä¢ Branch: `${{ github.ref_name }}`\n‚Ä¢ Commit: `${{ github.sha }}`\n‚Ä¢ Author: ${{ github.actor }}\n‚Ä¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: Notify Slack on deployment failure
      if: needs.test.result == 'success' && needs.deploy.result == 'failure'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"‚ùå *Full CI (E2E) Deployment Failed*\n‚Ä¢ Branch: `${{ github.ref_name }}`\n‚Ä¢ Commit: `${{ github.sha }}`\n‚Ä¢ Author: ${{ github.actor }}\n‚Ä¢ Tests passed but deployment failed\n‚Ä¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: Notify Slack on test failure
      if: needs.test.result == 'failure'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"‚ùå *Full CI (E2E) Pipeline Failed*\n‚Ä¢ Branch: `${{ github.ref_name }}`\n‚Ä¢ Commit: `${{ github.sha }}`\n‚Ä¢ Author: ${{ github.actor }}\n‚Ä¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}